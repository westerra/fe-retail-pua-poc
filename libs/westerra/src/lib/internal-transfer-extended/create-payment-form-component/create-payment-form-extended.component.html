<bb-header-ui *ngIf="header" headingClasses="bb-block bb-block--lg" headingType="h2" [heading]="header"></bb-header-ui>
<div #alertContainer>
  <ng-container *ngIf="errors?.length; else noSpecificError">
    <ng-container *ngFor="let error of errors">
      <ng-container *ngIf="error.message; else noSpecificError">
        <bb-alert-ui *ngIf="showApiError" title="" modifier="error">
          <div class="bb-text-bold bb-text-default d-inline-flex">
            <ng-container *ngIf="isErrorTitleDisplayed">
              <span i18n="@@initiate-payment-payments-error-alert-title"> Payment data error: </span>&nbsp;
            </ng-container>
            <span>{{ error | localizePaymentError: options.apiErrorTranslations }}</span>
          </div>
        </bb-alert-ui>
      </ng-container>
    </ng-container>
  </ng-container>
  <ng-template #noSpecificError>
    <ng-container *ngIf="genericError; else unknownError">
      <bb-alert-ui *ngIf="showApiError" title="" modifier="error">
        <div class="bb-text-bold bb-text-default">
          <ng-container *ngIf="isErrorTitleDisplayed">
            <span *ngIf="!options?.isTemplateMode" i18n="@@initiate-payment-payments-generic-message-alert-title">
              Payment data error:
            </span>
          </ng-container>
          <span>{{ genericError }}</span>
        </div>
      </bb-alert-ui>
    </ng-container>
  </ng-template>
  <ng-template #unknownError>
    <div class="bb-text-bold bb-text-default">
      <bb-alert-ui
        *ngIf="showApiError"
        i18n-title="@@initiate-payment-payments-unknown-error-alert-title"
        title="Server error: Unknown error occurred"
        modifier="error"
      >
      </bb-alert-ui>
    </div>
  </ng-template>
  <bb-alert-ui
    *ngIf="editPaymentHasNoChanges"
    i18n-title="@@initiate-payment-payments-edit-paymet-no-changes-warning-alert-title"
    title="Please make changes to continue."
    modifier="warning"
  ></bb-alert-ui>
  <bb-alert-ui *ngIf="showCustomApiError || showGeneralError" [dismissible]="false" modifier="error" title="Error">
    <ng-container *ngIf="showCustomApiError">
      <p>
        {{ customApiErrorMessage }}
        <a href="{{ link }}" *ngIf="link" class="alert-link" target="_blank">{{ linkText }}</a>
      </p>
    </ng-container>
    <ng-container *ngIf="showGeneralError">
      <p>
        {{ customErrorAlertMessage }}
      </p>
    </ng-container>
  </bb-alert-ui>
</div>

<ng-container
  *ngIf="
    enablePaymentTemplateSelector &&
    !options?.isTemplateMode &&
    options?.paymentMode !== paymentMode.EDIT_PAYMENT &&
    options?.paymentMode !== paymentMode.COPY_PAYMENT
  "
>
  <bb-payment-template-selector
    [paymentTemplateSearch]="paymentTemplateSearch"
    [items]="paymentTemplates$"
    [loading]="loadingTemplates$ | async"
    [templateName]="templateSelectorName || templateNameControl?.value"
    [searchValue]="searchValue"
    (setValues)="onSelectPaymentTemplate($event)"
    (loadMoreTemplates)="onLoadingMoreTemplates($event)"
    (searchTemplates)="search($event)"
    (clear)="clearTemplateName()"
  >
  </bb-payment-template-selector>
</ng-container>

<ng-container #outlet></ng-container>
<ng-template #content>
  <ng-container *ngIf="paymentState$ | async as paymentState">
    <ng-container *ngIf="configs.length === 1; else adaptiveFormTmpl">
      <bb-payord-form
        [config]="configs[0]"
        [formItem]="getForm(paymentState) | async"
        [submitting]="submitting$ | async"
        [isModalView]="options.isModalView"
        [isTemplateMode]="options.isTemplateMode"
        [isDebitPayment]="options.isDebitPayment"
        [paymentMode]="options.paymentMode"
        [templateModeType]="options.templateModeType"
        (clear)="onClear()"
        (discard)="discardPayment()"
        (submitted)="onSubmit($event)"
        (editPaymentCancel)="onEditCancel($event)"
        (editPaymentSubmit)="onEditSubmit($event)"
      >
      </bb-payord-form>

      <bb-confirmation-dialog
        data-role="discard-payment-edit-confirmation-dialog"
        confirmButtonColor="danger"
        (confirm)="discardEditPaymentChanges()"
        [isOpen]="isEditPaymentConfirmationDialogOpen"
        (cancel)="cancelEditPaymentConfirmationDialog()"
      >
        <span title i18n="@@confirmation-dialog.edit.payment.title.discard">Discard edited data?</span>
        <span body i18n="@@confirmation-dialog.edit.payment.body.discard">
          Are you sure you want to exit and discard all changes? Edited data will be lost.
        </span>
        <span confirmActionName i18n="@@confirmation-dialog.edit.payment.action.discard.confirm">Discard</span>
        <span cancelActionName i18n="@@confirmation-dialog.edit.payment.action.discard.cancel">Not now</span>
      </bb-confirmation-dialog>
    </ng-container>
    <ng-template #adaptiveFormTmpl>
      <bb-adaptive-form
        [formItem]="getForm(paymentState) | async"
        [paymentState]="paymentState"
        [paymentTypes]="configs"
        [baseFields]="baseFields$ | async"
        [fetchOptions$]="fetchOptions$"
        [fetchingOptions]="fetchingPaymentOptions$ | async"
        [paymentOptions$]="paymentOptions$"
        [paymentOptionsError]="paymentOptionsError$ | async"
        [selectedPaymentConfig]="selectedPaymentConfig$ | async"
        [selectedPaymentOption]="selectedPaymentOption$ | async"
        [fetchPaymentOptionsListener]="fetchPaymentOptionsListener$ | async"
        [shouldApplyTemplate]="shouldApplyTemplate"
        [checkClosedPaymentsAccess]="!!options.checkClosedPaymentsAccess"
        [submitting]="submitting$ | async"
        [isModalView]="options.isModalView"
        [isDebitPayment]="options.isDebitPayment"
        (selectConfig)="onSelectConfig($event)"
        (discard)="discardPayment()"
        (submitted)="onSubmit($event)"
        (selectPaymentOption)="onPaymentOptionSelect($event)"
        (clear)="onClear()"
        (applyPaymentTemplate)="onApplyTemplate($event)"
      ></bb-adaptive-form>
    </ng-template>
  </ng-container>
</ng-template>
